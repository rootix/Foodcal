<nz-modal
    [(nzVisible)]="isOpen"
    [nzTitle]="modalTitle"
    [nzContent]="modalContent"
    [nzFooter]="modalFooter"
    (nzOnCancel)="isOpen = false"
>
    <ng-template #modalTitle>
        {{ isNew ? 'Neues Menü' : 'Menü bearbeiten' }}
    </ng-template>

    <ng-template #modalContent>
        <form nz-form [formGroup]="form" nzLayout="vertical">
            <nz-form-item>
                <nz-form-label [nzSpan]="6" nzFor="dishes"> Speisen </nz-form-label>
                <nz-form-control [nzSpan]="18">
                    <nz-select
                        nzMode="multiple"
                        nzShowSearch
                        formControlName="dishes"
                        [nzOpen]="isSelectOpen"
                        (nzOpenChange)="isSelectOpen = $event"
                        [nzNotFoundContent]="notFoundTemplate"
                        (nzOnSearch)="searchText = $event"
                    >
                        @for (item of allDishes$ | async; track item.id) {
                            <nz-option
                                [nzLabel]="item.name"
                                [nzValue]="item.name"
                                [nzHide]="isSelected(item.name)"
                            ></nz-option>
                        }
                    </nz-select>
                    <ng-template #notFoundTemplate>
                        @if (allDishesLoading$ | async) {
                            <nz-spin></nz-spin>
                        } @else {
                            <div style="padding: 5px 12px; cursor: pointer" (mousedown)="addNewDish($event)">
                                @if (isCreatingDish) {
                                    <nz-spin nzSize="small"></nz-spin>
                                } @else {
                                    + "{{ searchText }}" erstellen
                                }
                            </div>
                        }
                    </ng-template>
                    @if (selectedDishes.length > 1) {
                        <button
                            type="button"
                            nz-button
                            nzType="link"
                            nzSize="small"
                            class="reorder-toggle"
                            (click)="isReorderVisible = !isReorderVisible"
                        >
                            {{ isReorderVisible ? 'Reihenfolge ausblenden' : 'Reihenfolge ändern' }}
                        </button>
                    }
                    @if (selectedDishes.length > 1 && isReorderVisible) {
                        <ol class="dish-order-list">
                            @for (
                                name of selectedDishes;
                                track name;
                                let i = $index;
                                let first = $first;
                                let last = $last
                            ) {
                                <li>
                                    <span>{{ name }}</span>
                                    <span class="dish-order-actions">
                                        <button
                                            type="button"
                                            nz-button
                                            nzType="text"
                                            nzSize="small"
                                            [disabled]="first"
                                            (click)="moveDish(i, -1)"
                                        >
                                            <i nz-icon nzType="up"></i>
                                        </button>
                                        <button
                                            type="button"
                                            nz-button
                                            nzType="text"
                                            nzSize="small"
                                            [disabled]="last"
                                            (click)="moveDish(i, 1)"
                                        >
                                            <i nz-icon nzType="down"></i>
                                        </button>
                                    </span>
                                </li>
                            }
                        </ol>
                    }
                </nz-form-control>
            </nz-form-item>
            <nz-form-item>
                <nz-form-label [nzSpan]="6" nzFor="notes"> Notizen </nz-form-label>
                <nz-form-control [nzSpan]="18">
                    <textarea rows="4" nz-input name="notes" id="notes" formControlName="notes"></textarea>
                </nz-form-control>
            </nz-form-item>
        </form>
    </ng-template>
    <ng-template #modalFooter>
        <button nz-button nzType="default" (click)="isOpen = false">Abbrechen</button>
        <button nz-button nzType="primary" (click)="onSubmit()" [nzLoading]="submitLoading">
            {{ isNew ? 'Erstellen' : 'Aktualisieren' }}
        </button>
    </ng-template>
</nz-modal>
